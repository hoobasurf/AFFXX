<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjbhT9EE0DkabbyQYFn17fTHFuGFF9bZY",
    authDomain: "affinix-3a930.firebaseapp.com",
    projectId: "affinix-3a930",
    storageBucket: "affinix-3a930.appspot.com",
    messagingSenderId: "498829285833",
    appId: "1:498829285833:web:344dacf5b6bcc818167018"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const form = document.getElementById("inscriptionForm");
  const messageDiv = document.getElementById("message");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    messageDiv.textContent = "";
    messageDiv.style.color = "inherit";

    const prenom = form.prenom.value.trim();
    const description = form.description.value.trim();
    const email = form.email.value.trim();
    const password = form.password.value;
    const departement = form.departement.value.trim();
    const rayon = form.rayon.value;
    const salles = Array.from(form.querySelectorAll('input[name="salles"]:checked')).map(cb => cb.value);

    if (salles.length === 0) {
      messageDiv.style.color = "#ff8080";
      messageDiv.textContent = "Merci de choisir au moins une salle.";
      return;
    }

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const uid = userCredential.user.uid;

      await setDoc(doc(db, "users", uid), {
        prenom,
        description,
        email,
        departement,
        rayon,
        salles
      });

      messageDiv.style.color = "#80ff80";
      messageDiv.textContent = "Inscription réussie ! Redirection...";
      setTimeout(() => {
        window.location.href = "ajout-photos.html";
      }, 1500);
    } catch (error) {
      if (error.code === "auth/email-already-in-use") {
        // Connexion auto
        try {
          await signInWithEmailAndPassword(auth, email, password);
          messageDiv.style.color = "#80ff80";
          messageDiv.textContent = "Connexion réussie ! Redirection...";
          setTimeout(() => {
            window.location.href = "ajout-photos.html";
          }, 1500);
        } catch (err) {
          messageDiv.style.color = "#ff8080";
          messageDiv.textContent = "Email déjà utilisé. Mauvais mot de passe.";
        }
      } else {
        messageDiv.style.color = "#ff8080";
        messageDiv.textContent = error.message;
      }
    }
  });
</script>
